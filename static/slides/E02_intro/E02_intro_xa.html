<!DOCTYPE html>
<html>
  <head>
    <title>Life-time Data Analysis</title>
    <meta charset="utf-8">
    <meta name="author" content="Andreas Bender" />
    <link href="libs/remark-css/example.css" rel="stylesheet" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Life-time Data Analysis
## Exercise 02: Non-parametric and parametric estimation
### Andreas Bender
### WS 2017/18

---



# Outline Lecture (Ch. 2)
**Non-parametric estimation**:

  - Life-table/actuarial method [Exercise 01]

  - Kaplan-Meier ([1958](http://www.jstor.org/stable/2281868)):
    - Rank 11 of [Nature's top 100 papers](http://www.nature.com/news/the-top-100-papers-1.16224#/interactive)

  - Nelson-Aalen ([1972](https://www.jstor.org/stable/pdf/1267144.pdf),
  [1978](http://projecteuclid.org/euclid.aos/1176344247))/Breslow

  - Kernel-Smoothers (MÃ¼ller and Wang [1994](http://www.jstor.org/stable/2533197))
&lt;br/&gt;
&amp;nbsp;

**Parameteric estimation**:

  - Maximum Likelihood

&lt;br/&gt;
&amp;nbsp;
**Log-Rank/Wilcoxon Test**

---
# Implementation in R

**Non-parametric**:

  - Life-table:
    - package: [**ldatools**](https://adibender.github.io/ldatools//index.html)
    - function:[`lifetable`](https://adibender.github.io/ldatools//reference/lifetable.html)

  - Kaplan-Meier:
    - package: [**survival**](https://cran.r-project.org/web/packages/survival/)
    - function: [`survfit`](https://www.rdocumentation.org/packages/survival/versions/2.41-2/topics/survfit)

  - Nelson-Aalen:
    - package: [**survival**](https://cran.r-project.org/web/packages/survival/)
    - function: [`survfit`](https://www.rdocumentation.org/packages/survival/versions/2.41-2/topics/survfit) with argument `type="aalen"`

  - Kernel-Smoothers:
    - package: [**muhaz**](https://cran.r-project.org/web/packages/muhaz/index.html)
    - function: [`muhaz`](https://www.rdocumentation.org/packages/muhaz/versions/1.2.6/topics/muhaz)

---
# Comparison of methods:
**Life-table**

- intervals: `\([a_{k-1}, a_k)\)`

- hazard: `\(\lambda_k = \frac{d_k}{n_k - w_k/2}\)`

- survival: `\(S_k = \prod_{\ell=1}^{k}(1 - \frac{d_k}{n_k - w_k/2})\)`


**Kaplan-Meier**

- intervals: `\([t_{(k-1)}, t_{(k)})\)`

- hazard: `\(\lambda_{k}=\frac{d_k}{n_k}\)`

- survival: `\(S(t)= \prod_{t_{(k)} &lt; t}(1-\frac{d_k}{n_k})\)`

---
# Comparison of methods (2)
&lt;img src="E02_intro_xa_files/figure-html/unnamed-chunk-1-1.png" style="display: block; margin: auto;" /&gt;

---
# Demo (1): Life-Table
[`lifetable`](https://adibender.github.io/ldatools/reference/lifetable.html)
function now uses correct left-closed intervals and accepts bare, unquoted names:


```r
# devtools::install_github("adibender/ldatools")
library(ldatools)
data(ovarian, package="survival")
ovarian[1, ] # observation with event at t = 59 will not be counted as event
```

```
##   futime fustat     age resid.ds rx ecog.ps
## 1     59      1 72.3315        2  1       1
```

```r
# in the first interval [0, 59)
lifetable(ovarian, breaks = c(0, 59, 1500), futime, fustat)
```

```
## # A tibble: 2 x 9
##   tstart   tend interval      n events dropouts riskset hazard survival
##    &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;     &lt;int&gt;  &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
## 1    0     59.0 [0,59)       26    0        0      26.0  0        1.00 
## 2   59.0 1500   [59,1500)    26   12.0     14.0    19.0  0.632    0.368
```

---
# Demo (2): Kaplan-Meier

```r
n &lt;- 100
dt &lt;- data.frame(tsurv=rweibull(n,0.5,2), tcens=rweibull(n,0.5,2)) %&gt;%
  mutate(time = pmin(tsurv, tcens), status=(tsurv &lt;= tcens)*1)
km &lt;- survfit(Surv(time, status)~1, data=dt)
plot(km)
```
&lt;img src="E02_intro_xa_files/figure-html/unnamed-chunk-4-1.png" style="display: block; margin: auto;" /&gt;

---
# Demo (3): Nelson-Aalen

```r
aalen &lt;- survfit(coxph(Surv(time, status)~1, data=dt), type="aalen")
plot(aalen)
lines(km, col=2, lty=1, lwd=0.9)
```
&lt;img src="E02_intro_xa_files/figure-html/unnamed-chunk-6-1.png" style="display: block; margin: auto;" /&gt;

---
# Demo (4): Kernel smoothers


```r
mz &lt;- muhaz::muhaz(dt$time, dt$status)
muhaz::plot.muhaz(mz, col=2, lwd=1.5)
lines(t&lt;-seq(0, 3, by=0.01), dweibull(t,0.5,2)/(1-pweibull(t,0.5,2)),
  lwd=1.5)
```

&lt;img src="E02_intro_xa_files/figure-html/unnamed-chunk-7-1.png" style="display: block; margin: auto;" /&gt;

---
# Extracting information
[**broom**](https://github.com/tidyverse/broom) package provides 3 main functions,
that are especially helpful if further preprocessing or customized post-processing
(e.g. plotting) of the results is necessary

  - [`tidy`](https://www.rdocumentation.org/packages/broom/versions/0.4.2/topics/tidy): Extract results of statistical analysis into (tidy) data.frame

  - [`augment`](https://www.rdocumentation.org/packages/broom/versions/0.4.2/topics/augment): Add information from model to original data (e.g. residuals, etc.)

  - [`glance`](https://www.rdocumentation.org/packages/broom/versions/0.4.2/topics/glance): One row summary of models (and other objects)


---
# Extracting information (2)

```r
broom::glance(km)
```

```
##   records n.max n.start events    rmean rmean.std.error    median
## 1     100   100     100     54 2.324237       0.5253605 0.6168716
##    conf.low conf.high
## 1 0.2952221  1.963037
```

```r
broom::tidy(km, conf.int=FALSE) %&gt;% select(1:5) %&gt;% head()
```

```
##           time n.risk n.event n.censor  estimate
## 1 1.818732e-05    100       0        1 1.0000000
## 2 3.870324e-04     99       0        1 1.0000000
## 3 4.372559e-04     98       1        0 0.9897959
## 4 9.942765e-04     97       0        1 0.9897959
## 5 9.986799e-04     96       0        1 0.9897959
## 6 2.460654e-03     95       1        0 0.9793770
```

---
# Extracting information (3)


```r
library(ggplot2)
theme_set(theme_bw())
library(ldatools) # needed for geom_stepribbon
ggplot(broom::tidy(km), aes(x = time, y = estimate)) +
  geom_step() +
  geom_stepribbon(aes(ymax = conf.high, ymin = conf.low), alpha = 0.2)
```

&lt;img src="E02_intro_xa_files/figure-html/unnamed-chunk-9-1.png" style="display: block; margin: auto;" /&gt;
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "zenburn",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {window.dispatchEvent(new Event('resize'));});
(function() {var d = document, s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler"); if (!r) return; s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }"; d.head.appendChild(s);})();</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
  }
});
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
